Sub SelectSheet()
    Dim sheetList As New Collection
    Dim sheet As Worksheet
    Dim selectedSheet As Worksheet
    Dim selectedSheetName As String
    Dim dialog As UserForm
    
    ' シートリストを作成する
    For Each sheet In ThisWorkbook.Sheets
        sheetList.Add sheet.Name
    Next sheet
    
    ' ダイアログを作成する
    Set dialog = UserForms.Add("SelectSheetDialog")
    
    ' ダイアログにシートリストを表示する
    For Each selectedSheetName In sheetList
        dialog.ListBox1.AddItem selectedSheetName
    Next selectedSheetName
    
    ' ダイアログを表示する
    dialog.Show
    
    ' 選択されたシートを取得する
    If dialog.DialogResult = vbOK Then
        On Error Resume Next
        Set selectedSheet = ThisWorkbook.Sheets(dialog.ListBox1.Value)
        On Error GoTo 0
        
        If Not selectedSheet Is Nothing Then
   ' 集計対象のシートのD列を検索し、"POS-MH"という値の行を見つける
    posMHValue = Application.Match("POS-MH", targetSheet.Columns("D"), 0)
    
    ' POS-MHの行から順にデータを集計する
    If Not IsError(posMHValue) Then
        compareRowIndex = 10 ' compareシートの書き込み開始行
        compareMaxValue = targetSheet.Cells(posMHValue, "E").Value + level
        
        Do While targetSheet.Cells(posMHValue, "E").Value <= compareMaxValue
            ' E列の数値がcompareMaxValue以下の場合、データを書き込む
            If targetSheet.Cells(posMHValue, "E").Value <= compareMaxValue Then
                compareSheet.Cells(compareRowIndex, "A").Value = targetSheet.Cells(posMHValue, "A").Value
                compareSheet.Cells(compareRowIndex, "B").Value = targetSheet.Cells(posMHValue, "B").Value
                compareSheet.Cells(compareRowIndex, "C").Value = targetSheet.Cells(posMHValue, "C").Value
                compareSheet.Cells(compareRowIndex, "D").Value = targetSheet.Cells(posMHValue, "D").Value
                compareSheet.Cells(compareRowIndex, "E").Value = targetSheet.Cells(posMHValue, "E").Value
                compareRowIndex = compareRowIndex + 1
            End If
            
            posMHValue = posMHValue + 1
        Loop
    End If
        End If
    End If
    
    ' ダイアログを削除する
    Unload dialog
End Sub

